<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Gavin COM</title>
    <script src="./public/js/flexible.js"></script>
    <link rel="stylesheet" href="./public/css/bootstrap.min.css">
    <link rel="stylesheet" href="./public/css/index.css">
</head>

<body>
    <div class="body-box">
        <div class="tool-bar">
            <div class="select-data">
                <div class="form-group">
                    <label for="disabledSelect">选择串口</label>
                    <select id="disabledSelect" class="form-control com">
                    </select>
                </div>
                <div class="form-group">
                    <label for="BaudRate">波特率</label>
                    <input type="text" class="form-control" id="BaudRate" value="9600">
                </div>
            </div>
            <div class="submit-data">
                <button class="btn btn-primary btn-block btn-submit">打开</button>
                <button id="btnClose" class="btn btn-primary btn-block">关闭</button>

            </div>
        </div>
        <div class="content-box">
            <div class="receive-box">
                <div class="send-header">
                    <label>接受信息</label>
                </div>
                <!-- <div class="receive-windows">
                </div> -->
            </div>
            <div class="receive-box">
                <div class="send-header">
                    <label>当前重量</label>
                </div>
                <div id="div_value" style="color:red;font-size:50px">
                </div>
            </div>
            <div class="send-box">
                <div class="send-header">
                    <label>发送信息</label>
                </div>
                <div class="send-windows">
                    <textarea class="input-send-data"></textarea>
                </div>
                <div class="send-btn">
                    <div class="btn-box">
                        <div class="btn btn-warning btn-send">发送信息</div>&nbsp&nbsp&nbsp
                        <div class="btn btn-danger btn-reset">清空信息</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    window.$ = window.jQuery = require('./public/js/jquery.min.js');
    let SerialPort = require('serialport');
    const ByteLength = SerialPort.parsers.ByteLength
    const Delimiter = SerialPort.parsers.Delimiter;
    let port = null;

    let parser = null;
    SerialPort.list((err, ports) => {
        for (let item of ports) {
            $('.com').append(`<option>${item.comName}</option>`)
        }
        console.log(ports);
    });
    $('.btn-submit').click((data) => {
        let COM = $('select option:selected').text();
        let BaudRate = $('#BaudRate').val();
        console.log(COM);
        console.log(BaudRate);
        port = new SerialPort("/dev/tty.usbserial", {
            baudRate: parseInt(BaudRate),
            stopBits: 2,
            parity: 'none'
        });
        // parser = port.pipe(new ByteLength({ length: 8 }));
        // parser = port.pipe(new Delimiter({ delimiter: '\n' }));

        $('.receive-windows').text(`打开串口: ${COM}, 波特率: ${BaudRate}`);
        $('.receive-windows').append('<br/>=======================================<br/>');
        var datas = [];
        var buffers = new Buffer(6);
        var data_string = '';


        port.on('data', data => {
            var values = '';
            var status = '';
            var status_obj = {};
            if (data.byteLength <= 5) {
                if (data.byteLength == 1 && data.toString('hex') == 'ff') {
                    data_string = data.toString('hex');
                } else {
                    if ((data_string.length + data.toString('hex').length) <= 10) {
                        data_string += data.toString('hex');
                    } else {
                        data_string = '';
                        console.log('无效数据')
                    }
                    if (data_string.length == 10) {
                        values = data_string.toUpperCase();
                        //取状态位。转换为二进制
                        status = parseInt(values.substring(2, 4), 16).toString(2).padStart(8, '0');
                        //7 0:量程内  1:超载
                        if (parseInt(status[0])) {
                            status_obj.overload = true;
                        } else {
                            status_obj.overload = false;
                        }
                        if (parseInt(status[2])) {
                            status_obj.plus = false;
                        } else {
                            status_obj.plus = true;
                        }
                        if (parseInt(status[3])) {
                            status_obj.stable = true;
                            console.log('稳定数据');
                        } else {
                            status_obj.stable = false;
                            console.log('非稳定数据');
                        }
                        var value = values.substring(8, 10) + values.substring(7, 8) + values.substring(4, 6);
                        // console.log('小数:', parseInt(status.substring(5, 8)))
                        status_obj.value = parseInt(value) / Math.pow(10, parseInt(status.substring(5, 8) - 1))
                        if (!status_obj.plus) {
                            status_obj.value = status_obj.value * -1;
                        }
                        console.log('最终重量:', status_obj.value)
                        // $('#div_value').in
                        $("#div_value").html(status_obj.value)
                    }
                }
            } else {
                console.log('无效数据')
            }

            $('.receive-windows').append(values + '===');
        });
    });


    $('#btnClose').click(() => {
        port.close(error => {
            console.log('error', error)
        })
    })
    // 点击发送信息
    $('.btn-send').click(() => {
        var sendData = $('.input-send-data').val();
        if (port != {} && port != null) {
            console.log(`SendData: ${sendData}`);
            port.write(sendData);
        }
    })
    // 清空信息
    $('.btn-reset').click(() => {
        $('.input-send-data').val('');
    })
</script>

</html>